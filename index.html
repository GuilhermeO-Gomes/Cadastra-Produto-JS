<!doctype html>
<html>
  <head>
    <title>Lista de Compras</title>
    <meta charset="UTF-8" />
    <style>
      .borda_tabela {
        border: 2px solid black;
        border-collapse: collapse;
        padding: 5px;
        margin-bottom: 10px;
      }

      .invisivel {
        visibility: hidden;
      }
    </style>
  </head>

  <body>
    <h1>Cadastro de Produtos(Array de Objetos)</h1>
    <label>Produto: <input id="produto_input" placeholder="Ex: Mouse" /></label>
    <label>Preço(R$): <input id="preco_input" placeholder="Ex: 99.90" /></label>
    <label>Quantidade: <input id="qtd_input" placeholder="Ex: 2" /></label>

    <button onclick="adicionar_produto()">Adicionar Produto</button>
    <button onclick="alterar_toggle_lista_produto()">Listar Produto</button>
    <button onclick="alterar_toggle_resumo()">Resumo</button>
    <button onclick="limpar_lista()">Limpar tudo</button>
    <hr />

    <h2>Remover por Índice</h2>
    <input id="remove_indice" placeholder="Ex: 0" />
    <button onclick="remove_produto()">Remover</button>
    <h2 id="texto_cadastro"></h2>
    <p id="aviso"></p>
    <h1 id="notificacao_2"></h1>
    <p id="p_produto"></p>
    <p id="p_itens_qtd"></p>
    <p id="p_total"></p>
    <h1 id="notificacao"></h1>

    <script>
      //Aqui todas as variáveis globais do projeto
      let lista = [];
      let lista_itens_qtd = [];
      let lista_subtotal = [];
      let produto = document.getElementById("produto_input");
      let preco = document.getElementById("preco_input");
      let qtd = document.getElementById("qtd_input");
      let visibilidade = true;
      let visibilidade_2 = true;
      let somador = 0;
      let somador_subtotal = 0;

      //Função que pega os valores dos inputs, coloca num objeto e manda para uma lista
      function adicionar_produto() {
        let aviso = document.getElementById("aviso");
        //Conversão de tipo de dados para não ter problemas posteriores
        let valor_preco = parseFloat(preco.value);
        let valor_qtd = parseInt(qtd.value);
        let item = {
          Índice: lista.length,
          Produto: produto.value,
          Preço: valor_preco,
          QTD: valor_qtd,
          Subtotal: valor_qtd * valor_preco,
        };

        //Essas outras listas são para fins de estatística na função Resumo
        lista_subtotal.push(item.Subtotal);
        lista_itens_qtd.push(valor_qtd);
        lista.push(item);

        aviso.textContent = `Produto adicionado. Total cadastrado: ${lista.length}`;
        console.log(lista);
        limpar_input();
      }

      //Função criada puramente para que, a cada clique, mude a variável de estado e consiga controlar a visibilidade do conteúdo
      function alterar_toggle_lista_produto() {
        visibilidade = !visibilidade;
        lista_produto();
      }

      //Essa função primeiro destroí todas as tabelas já criadas, deixando tudo limpo, logo após, cria as tabelas
      function lista_produto() {
        const notificacao = document.getElementById("notificacao");
        let aviso = document.getElementById("aviso");

        //Percorre a NodeList e aplica element.remove() em cada uma
        let todas_tabelas = document.querySelectorAll("table");
        todas_tabelas.forEach((tabela) => tabela.remove());

        //Percorre cada elemento do array principal e cria uma tabela para cada um
        lista.forEach((elemento) => {
          let tabela = document.createElement("table");
          //Esse id serve para remover índice depois
          tabela.id = `tabela_${elemento.Índice}`;

          let tr1 = document.createElement("tr");
          let tr2 = document.createElement("tr");
          let prop;
          let valor;
          let th;
          let td;

          Object.keys(elemento).forEach((chave) => {
            //Eu guardo a chave e o valor dentro de variáveis let, para ela mudar de valor a cada iteração
            prop = chave;
            valor = elemento[chave];

            th = document.createElement("th");
            td = document.createElement("td");
            th.textContent = prop;
            td.textContent = valor;
            td.classList.add("borda_tabela");
            th.classList.add("borda_tabela");
            tr1.appendChild(th);
            tr2.appendChild(td);
          });

          //Eu subo as tr´s já preenchidas para a tabela como último filho dentro da tabela
          tabela.appendChild(tr1);
          tabela.appendChild(tr2);
          document.body.appendChild(tabela);

          notificacao.textContent = "Produtos Cadastrados: ";
          aviso.textContent = "";

          tabela.classList.add("borda_tabela");
          //Verificação para sempre que clica o botão, mude a visibilidade
          if (visibilidade) {
            notificacao.classList.add("invisivel");
            tabela.classList.add("invisivel");
          } else {
            notificacao.classList.remove("invisivel");
            tabela.classList.remove("invisivel");
          }
        });
        limpar_input();
      }

      //Mesma ideia da outra função de visibilidade
      function alterar_toggle_resumo() {
        visibilidade_2 = !visibilidade_2;
        resumo_dados();
      }

      //Função que pega aquelas listas lá do adicionar_produto() e soma todos os elementos
      function resumo_dados() {
        let notificacao_2 = document.getElementById("notificacao_2");
        const p_produto = document.getElementById("p_produto");
        const p_itens = document.getElementById("p_itens_qtd");
        const p_total = document.getElementById("p_total");

        lista_itens_qtd.forEach((elemento) => {
          somador += elemento;
        });
        console.log(somador);

        lista_subtotal.forEach((elemento) => {
          somador_subtotal += elemento;
        });
        console.log(somador_subtotal);

        notificacao_2.textContent = "Resumo";
        p_produto.textContent = `Total de produtos (linhas): ${lista.length}`;
        p_itens.textContent = `Total de itens (Somando as quantidades): ${somador}`;
        p_total.textContent = `Valor total do estoque: R$ ${somador_subtotal}`;

        if (visibilidade_2) {
          notificacao_2.classList.add("invisivel");
          p_produto.classList.add("invisivel");
          p_itens.classList.add("invisivel");
          p_total.classList.add("invisivel");
        } else {
          notificacao_2.classList.remove("invisivel");
          p_produto.classList.remove("invisivel");
          p_itens.classList.remove("invisivel");
          p_total.classList.remove("invisivel");
        }
        limpar_input();
      }

      //Função que esvazia todos os elementos do array com array.length e lista de tabela
      function limpar_lista() {
        let aviso = document.getElementById("aviso");
        let todas_tabelas = document.querySelectorAll("table");

        todas_tabelas.forEach((tabela) => tabela.remove());
        lista.length = 0;
        lista_itens_qtd.length = 0;
        lista_subtotal.length = 0;
        lista_produto.length = 0;
        somador = 0;
        somador_subtotal = 0;

        aviso.textContent = "Todos os produtos foram removidos!";
        limpar_input();
      }

      //Função que faz remoção por índice, ele usa splice na lista de objetos e ele "pega" os id´s das tabelas
      function remove_produto() {
        const input_remove = document.getElementById("remove_indice");
        const input_remove_int = parseInt(input_remove.value);
        if (input_remove_int === 0) {
          lista.splice(`${input_remove_int}`, `${input_remove_int + 1}`);
        } else {
          lista.splice(`${input_remove_int}`, `${input_remove_int}`);
        }

        let tabela_removivel = document.getElementById(
          `tabela_${input_remove_int}`,
        );

        tabela_removivel.remove();

        aviso.textContent = "";
        limpar_input();
      }

      //Função presente em todas as outras, que serve para limpar os inputs
      function limpar_input() {
        const input_remove = document.getElementById("remove_indice");
        input_remove.value = "";
        produto.value = "";
        preco.value = "";
        qtd.value = "";
      }
    </script>
  </body>
</html>
